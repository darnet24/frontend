---
const BACKEND_URL = import.meta.env.PUBLIC_BACKEND_URL || import.meta.env.PUBLIC_API_URL;
---

<section class="bg-white text-black py-10 px-4">
  <div class="max-w-2xl mx-auto">
    <h2 class="text-2xl md:text-3xl font-bold mb-3 text-center">Zostań z nami</h2>
    <p class="mb-4 text-gray-700 text-center text-sm md:text-base">
      Dołącz do naszego newslettera i otrzymuj porady IT, nowości i oferty specjalne raz w miesiącu.
    </p>

    <form
      id="newsletter-form"
      class="flex flex-col gap-3 text-sm"
      method="POST"
      novalidate
      data-backend-url={BACKEND_URL}
    >
      <div class="flex flex-col sm:flex-row gap-2 items-start sm:items-center">
        <input
          type="email"
          name="email"
          placeholder="Twój adres e-mail"
          required
          class="flex-grow w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500 text-black font-sans"
        />
        <button type="submit" class="bg-black text-white px-5 py-2 rounded hover:bg-gray-800">
          Zapisz się
        </button>
      </div>

      <label class="flex items-start gap-2 text-gray-700 leading-snug">
        <input type="checkbox" name="zgodaNewsletter" required class="mt-1 w-4 h-4" />
        <span>
          Wyrażam zgodę na przetwarzanie moich danych osobowych w celu otrzymywania newslettera,
          zgodnie z
          <a href="/polityka-prywatnosci" class="underline text-blue-600 hover:text-blue-500">Polityką prywatności</a>.
        </span>
      </label>

      <div id="newsletter-status-wrapper" class="transition-opacity duration-500 opacity-0 h-5 flex items-center gap-2 text-sm font-semibold">
        <svg id="newsletter-spinner" class="w-4 h-4 animate-spin text-yellow-500 hidden" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 100 16v-4l-3 3 3 3v-4a8 8 0 01-8-8z"></path>
        </svg>
        <span id="newsletter-status"></span>
      </div>
    </form>
  </div>

  <script is:inline>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("newsletter-form");
      const API_BASE_URL = form.dataset.backendUrl;

      const zgoda = form.querySelector("input[name='zgodaNewsletter']");
      const statusWrapper = document.getElementById("newsletter-status-wrapper");
      const statusEl = document.getElementById("newsletter-status");
      const spinner = document.getElementById("newsletter-spinner");

      zgoda.addEventListener("invalid", () => {
        zgoda.classList.add("ring-2", "ring-red-500", "ring-offset-2");
      });

      zgoda.addEventListener("change", () => {
        if (zgoda.checked) {
          zgoda.classList.remove("ring-2", "ring-red-500", "ring-offset-2");
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!zgoda.checked) {
          spinner.classList.add("hidden");
          statusWrapper.classList.remove("opacity-0");
          statusEl.textContent = "❌ Błąd: Zgoda RODO jest wymagana.";
          statusEl.className = "text-red-500 text-sm font-semibold";
          zgoda.classList.add("ring-2", "ring-red-500", "ring-offset-2");
          return;
        }

        const data = {
          email: form.email.value,
          zgodaNewsletter: "true"
        };

        spinner.classList.remove("hidden");
        statusEl.textContent = "Wysyłanie...";
        statusEl.className = "text-yellow-500 text-sm font-semibold";
        statusWrapper.classList.remove("opacity-0");

        try {
          const res = await fetch(`${API_BASE_URL}/api/newsletter`, {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          const result = await res.json();
          spinner.classList.add("hidden");

          if (result.success) {
            statusEl.textContent = "✅ Zapisano do newslettera.";
            statusEl.className = "text-green-500 text-sm font-semibold";
            form.reset();
          } else {
            statusEl.textContent = "❌ Błąd: " + result.message;
            statusEl.className = "text-red-500 text-sm font-semibold";
          }
        } catch (err) {
          spinner.classList.add("hidden");
          statusEl.textContent = "❌ Nie udało się zapisać. Spróbuj później.";
          statusEl.className = "text-red-500 text-sm font-semibold";
          console.error("Błąd w fetch /api/newsletter:", err);
        }
      });
    });
  </script>
</section>
